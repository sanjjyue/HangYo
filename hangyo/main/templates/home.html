{%load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hangyo</title>
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a1e71c3e49ea6232c6622dd828be2a59"></script>
</head>
<body>
    
    <div class="mainbox">
        
        <!-- 검색바 -->
        <div class="top-container">
            <div class="local-box">
                <div class="localname">
                    장전동
                </div>
            </div>

            <div class="search-box">
                <input type="text" class="search-loca" name="searchlocation" placeholder="위치를 검색하세요">
            </div>

            <div class="i_searchloca">
                <img class="magnifying-glass" src="{% static 'image/magnifying-glass.png' %}" >
            </div>
        </div>

        <!-- 지도 -->
        <div class="map" id="map"></div>
        
        <!-- 카테고리바 -->
        <div class="categorybar">
            <button class="btn_myloca" id="categorybutton" onclick='panTo()'>
                <div class="categorybox">
                    <div id="categoryicon">
                        <img src="{% static 'image/geo.png' %}">
                    </div>
                    <div id = "categoryname">내 위치</div>
                </div>
            </button>
                    
            <button class="btn_checkbalance" id="categorybutton">
                <div class="categorybox">
                    <div class="i_checkbalance" id="categoryicon">
                        <img src="{% static 'image/money-bag.png' %}">
                    </div>
                    <div id = "categoryname">잔액 확인</div>
                </div>
            </button>
                    
            <button class="btn_resetinfo" id="categorybutton">
                <div class="categorybox">
                    <div class="i_resetinfo" id="categoryicon">
                        <img src="{% static 'image/gear.png' %}">
                    </div>
                    <div id = "categoryname">정보 재설정</div>
                </div>
            </button>
        </div>
    </div>
    
    <!-- 잔액 확인 팝업창 -->
    <div class="checkbalance" id="modal">
        <div class="popupbox_checkbalance">
            <div class="iconbox">
                <img src="{% static 'image/coin.png' %}">
            </div>
            <div class="btn_close_checkbalance">&times;</div>
            <div class="titlebox_checkbalance">
                <div class="title">잔액 확인</div>
            </div>
            <div class="contentbox">
                <div class="content">
                    김태훈님의 현재 계좌 잔액은 $ 999,999원 입니다.
                </div>
            </div>
            <input type="button" id="btn_iknow" class="btn_iknow" value="알겠어요!">
        </div>
    </div>    

    <!-- 정보 재설정 팝업창 -->
    <div class="resetinfo">
        <div class="popupbox_resetinfo">
            <div class="iconbox">
                <img src="{% static 'image/Lovepik.png' %}">
            </div>
            <div class="btn_close_resetinfo">&times;</div>
            <div class="titlebox_resetinfo">
                <div class="title">간편 정보 저장</div>
            </div>
            <div class="inputbox">
                <input type="text" class="input-info" name="name" placeholder="이름">
                <input type="text" class="input-info" name="location" placeholder="장소">
                <input type="text" class="input-info" name="cardnumber" placeholder="카드번호(012345678901)">
            </div>
            <div class="notebox">
                <div class="note">
                    ※ 본 정보는 잔액확인 및 위치설정 등 사용자 편의성을 위해서만 사용됩니다.
                </div>
            </div>
            <input type="button" id="btn_saveinfo" class="btn_saveinfo" value="확인">
        </div>
    </div>

    <!-- 가게 정보 팝업창 -->
    

    <script src="{% static 'js/map.js' %}"></script>
    <script src="{% static 'js/popup.js' %}"></script>


    <script>
var container = document.getElementById('map');
var options = {
    center: new kakao.maps.LatLng(35.234104, 129.078411),
    level: 3
};
// public static final MapView.CurrentLocationTrackingMode TrackingModeOnWithHeading
var map = new kakao.maps.Map(container, options);

//마커 속성
var imageSrc = "/static/image/marker_store.png",
    imageSize = new kakao.maps.Size(30 ,40), 
    imageOption = {offset: new kakao.maps.Point(27, 69)}; //좌표랑 일치시킬 마커내의 좌표
var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption)
//현위치 마커속성
var imageSrc1 = "/static/image/marker_me.png",
    imageSize1 = new kakao.maps.Size(20,20);
    // imageOption1 = {offset: new kakao.maps.Point(27, 69)}; //좌표랑 일치시킬 마커내의 좌표
var markerImage1 = new kakao.maps.MarkerImage(imageSrc1, imageSize1)
//내위치 버튼 연결
var here = document.querySelector('.btn_myloca')
//현재위치 마커표시
if (navigator.geolocation) {
// 접속위치 얻어오기
    navigator.geolocation.getCurrentPosition(function(position) {
        
        var lat = position.coords.latitude, // 위도
            lon = position.coords.longitude; // 경도
        
        var locPosition = new kakao.maps.LatLng(lat, lon);
        
        displayMarker(locPosition, message); 
            
    });
    
} else { //GeoLocation을 사용할 수 없을때
    
    var locPosition = new kakao.maps.LatLng(33.450701, 126.570667),    
        message = 'geolocation을 사용할수 없어요..'
        
    displayMarker(locPosition, message);
}     
function displayMarker(locPosition, message) {

// 마커 생성
var marker1 = new kakao.maps.Marker({  
    map: map, 
    image:markerImage1,
    position: locPosition
}); 

marker1.setMap(map);  

}    

// 버튼생성 후 특정 위치로 부드럽게 이동
function panTo() { 
    navigator.geolocation.getCurrentPosition(function(position) {
        
        var lat = position.coords.latitude, // 위도
            lon = position.coords.longitude; // 경도
        
        var locPosition = new kakao.maps.LatLng(lat, lon);
    
        map.panTo(locPosition);
    });
} 
// 지도 줌
var zoomControl = new kakao.maps.ZoomControl();
map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);


//마커 관련 툴

var positions = [
    {% for i in take_all_info %}
    {
    content: ''+
    '<div class="storeinfo">'+
        '<div class="popupbox_storeinfo">' + 
            '<div class="bar1"></div>' + 
            '<div class="bar2"></div> ' +
            '<div class="store">' + 
                '<div class="storename">' + 
                    '{{i.store_name}}' + 
                '</div>' +
                '<div class="storecategory-box">' +
                    '<div class="storecategory">' +
                        '{{i.store_type}}' +
                        '</div>' +
                        '</div>' +
                        '</div>' +

                        '<div class="storeloca-box">' +
                            '<div class="i_storeloca" id="storeinfoicon">' +
                                '<img src="{% static 'image/geo.png' %}">' +
                                '</div>' +
                                '<div class="storeloca">' +
                                    '{{i.location}}' +
                                    '</div>' +
                                    '</div>' +

                                    '<div class="storenumber-box">' +
                                        '<div class="i_storenumber" id="storeinfoicon">' +
                                            '<img src="{% static 'image/page-2.png' %}">' +
                                            '</div>' +
                                            '<div class="storenumber">' +
                                                '{{i.phone_num}}' +
                                                '</div>' +
                                                '</div>' +

                                                '<div class="storeinfo-btn-box">' +
                                                    '<button class="btn_directions" id="storebutton">' +
                                                        '<div class="i_directions" id="storeicon">' +
                                                            '<img src="{% static 'image/junction.png' %}">' +
                                                            '</div>' +
                                                            '<div id = "btnname">길찾기</div>' +
                                                            '</button>' +
            
                                                            '<button class="btn_call" id="storebutton">' +
                                                                '<div class="i_call" id="storeicon">' +
                                                                    '<img src="{% static 'image/page-1.png' %}">' +
                                                                    '</div>' +
                                                                    '<div id = "btnname">전화연결</div>' +
                                                                    '</button>' +           
                                                                    '<button class="btn_report" id="storebutton">' +
                                                                        '<div class="i_report" id="storeicon">' +
                                                                            '<img src="{% static 'image/siren.png' %}">' +
                                                                            '</div>' +
                                                                            '<div id = "btnname">제보하기</div>' +
                                                                            '</button>' +
                                                                            '</div>' +
                                                                            '</div>' + 
                                                                            '</div>'
    , 
    latlng: new kakao.maps.LatLng({{i.Latitude}}, {{i.longitude}})
    },
    {% endfor %} 
];
// var positions = [
//     {
//     content: '<div>부산대</div>', 
//     latlng: new kakao.maps.LatLng(35.234104, 129.078411)
//     },
//     {
//     content: '<div>카페드팽</div>', 
//     latlng: new kakao.maps.LatLng(35.230288, 129.084147)
//     },
//     {
//     content: '<div>벅구냥냥펀치</div>', 
//     latlng: new kakao.maps.LatLng(35.231172, 129.085223)
//     }
// ];


//커스텀 오버레이 생성
// for (var i = 0; i < contents.length; i ++) {
//     var marker = new kakao.maps.Marker({
//         position: contents[i].latlng, 
//         image: markerImage, 
//         map: map,
        // clickable: true
    // });
    // var overlay  = new kakao.maps.CustomOverlay({
    //     content : contents[i].content,
    //     map:map,
    //     position : contents[i].
    //     lating
    // });
    // marker.setMap(map)
    // kakao.maps.event.addListener(marker, 'click', function(){
    //     overlay.setMap(map);
    // });
        // kakao.maps.event.addListener(marker, 'click', clickListener(map,marker,overlay));
// }


// function clickListener(map,marker,overlay){
//     return function(){
//         overlay.open(map, marker,overlay);
//     };
// }
// function closeOverlay(){
//     overlay.setMap(null);
// }



console.log(positions)
// 마커 생성
for (var i = 0; i < positions.length; i ++) {
    var marker = new kakao.maps.Marker({
        position: positions[i].latlng, 
        image: markerImage, 
        clickable: true
    });
    var iwRemoveable = true; // true일 때 X버튼 생성
    // 인포윈도우를 생성
    var infowindow = new kakao.maps.InfoWindow({
        content : positions[i].content,
        removable : iwRemoveable
    });
    marker.setMap(map);  
    kakao.maps.event.addListener(marker, 'click', clickListener(map,marker,infowindow));
}
function clickListener(map,marker,infowindow){
    return function(){
        infowindow.open(map, marker,infowindow);
    };
}

    </script>
</body>
</html>